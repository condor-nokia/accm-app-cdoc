include::ROOT:conf/Configuration_properties.adoc[leveloffset=0]

= How to retrieve intent health as {vno-initials}

== Introduction

This section describes how to use the {app-short-name} metrics proxy as an {vno-initials} for getting intent health.

When {app-short-name} is installed over Altiplano, the {vno-initials} can retrieve all the metrics
through the WebUI and the application proxy(using openTSDB REST queries) including the intent health values.

When the {vno-initials} wants to execute REST queries to openTSDB, instead of using the Altiplano's URL:
https://{altiplano-host}/altiplano-opentsdb/
it must point to {app-short-name} proxy URL:
https://{altiplano-host}/{wnp-pm-context}/

[NOTE]
====
Before using {app-short-name} as an {vno-initials} you must be authenticated as {vno-initials} user.
Refer to xref:User_Guide:How_to_manage_WNP_access.adoc[How to Manage {app-short-name} access] section to know the steps needed.
====

== Using the {app-short-name} WebUI

The intent health information in the WebUI is shown in the ONT and Service intent lists.

The *Last Available Health* column shows the intent health value which can be
one of the next possible values:

* "Healthy"
* "Unknown"
* "At-risk"
* "Faulty"
* "Suspended"

=== ONTs
For example, to retrieve the intent health of the ont intents follow the next steps:

. Click the "{ont-initials}s" option on the menu bar displayed on top of the screen.
+
image::vno_portal/ONTs_menu.png[align="center"]

. All ONTs will be listed:
+
image::vno_portal/ONTsSection.png[align="center"]

. In *Last Available Health* column the health state is shown:
+
image::vno_portal/health_column.png[align="center"]

== Using the REST Proxy
To retrieve intent health metrics using the {app-short-name} openTSDB proxy a POST or GET request must be sent to the URL:
https://{altiplano-host}/{wnp-pm-context}/api/query

[NOTE]
====
The url is the same as the offered by Altiplano OpenTSDB but the difference is that instead of pointing to
altiplano-opentsdb context the URL points to {app-short-name} proxy context (*{wnp-pm-context}*).
====

To retrieve the information using a POST HTTP method, the request must be sent to the url:
https://{altiplano-host}/{wnp-pm-context}/api/query
including a body like the following one:
[source, json]
----
{
    "start": "<START_DATE>",
    "end": "<END_DATE>",
    "queries": [
        {
            "metric": "<METRIC_NAME>.<INTENT_TYPE>_<INTENT_TYPE_VERSION>.<DEVICE_NAME>",
            "aggregator": "<OPENTSDB_AGGREGATOR>",
            "tags": {
                "target": "<TARGET>"
            }
        }
    ]
}
----

To retrieve the information using an HTTP GET method, the request must be sent including the query in the same URL as shown below:
https://{altiplano-host}/{wnp-pm-context}/api/query?start=<START_DATE>&end=<END_DATE>&m=<OPENTSDB_AGGREGATOR>:<METRIC_NAME>.<INTENT_TYPE>_<INTENT_TYPE_VERSION>.<DEVICE_NAME>.<BOARD>{target=<TARGET>}

The information inside the query is described in the next lines:

* *START DATE:* This parameter defines the beginning of the time range.
It indicates the earliest point in time from which you want to start fetching the data.
The time can be in various formats such as:

** A specific date/time (e.g., "2025/01/01 00:00:00").
** A relative time like "1d-ago" (1 day ago), "1h-ago" (1 hour ago), etc.
** A unix timestamp (e.g., 1609459200).

    Example: If you set start = "2025/01/01 00:00:00", the query will retrieve data starting from January 1st, 2025 at midnight.

* *END_DATE (optional):* This parameter defines the end of the time range.
It marks the latest point in time up to which data should be returned.
The format is similar to start. If it is not sent, then the end value will be the actual date.
The time can be in various formats such as:

** A specific date/time (e.g., "2025/01/31 23:59:59").
** A relative time like "now" (current time), "1h-ago", etc.
** A unix timestamp (e.g., 1609545600).

    Example: If you set end = "2025/01/31 23:59:59", the query will fetch data up until January 31st, 2025 at 11:59:59 PM.

* *METRIC_NAME:* it corresponds to the counter name that has been defined in the collection model.
In this case the metric name always will be "hi.summary".
Also {main-base-app} docs can be accessed to get more information.

* *INTENT_TYPE:* it corresponds to the intent type identifier.

* *INTENT_TYPE_VERSION:* it corresponds to the intent type's version.

* *DEVICE_NAME:* It is the target of the intent that was used to configure the OLT plus the board where it is connected. For example: Condor-LS.LT1
The available device names can be retrieved using the REST API offered by {app-short-name}.
See xref:How_to_get_opentsdb_metrics_as_VNO.adoc#_retrieve_available_device_names[Retrieve available device names] section for more details.

* *BOARD:* The board identifier where the elements are connected. For example: LT1

* *OPENTSDB_AGGREGATOR:* Allows you to group and summarize time series data to facilitate
analysis and derive useful insights from large datasets.
In this case the aggregator always will be "sum".
Consult openTSDB official docs for more information.

* *TARGET:* This tag can be used to filter the intent health metrics for a desired target identifier. For example if we need only the metrics for an intent type with target L1.P1.W1 then the value
"L1.P1.W1" must be included in this tag.
A wildcard (\*) can be used in this field as value to retrieve the elements for all targets
without specifying a specific one. If this tag is not included in the query, the results are the same
as if the (*) is sent.
+
[NOTE]
====
As the data is retrieved from {main-base-app}'s openTSDB through {app-short-name} proxy, the special chars in the queries must be
replaced as suggested in Altiplano's docs:

*"#" (numeral symbol)*: "\__h_"

*":" (colon)*: "\__c_"

*" " (space)*: "\__s_"

*"=" (equal sign)*: "\__e_"

====

The response will show the next information:
[source, json]
----
[
    {
        "metric": "<METRIC_NAME>.<INTENT_TYPE>_<INTENT_TYPE_VERSION>.<DEVICE_NAME>",
        "tags": {
            "target": "<TARGET>"
        },
        "aggregateTags": [],
        "dps": {
            "<TIMEX>": "<INTENT_HEALTH_VALUEX>",
            "<TIMEX>": "<INTENT_HEALTH_VALUEX>",
            "<TIMEX>": "<INTENT_HEALTH_VALUEX>",
            "<TIMEX>": "<INTENT_HEALTH_VALUEX>"
        }
    }
]
----

The information inside the response is described in the next lines:

* *TIMEX:* It represents the time in which the intent health was collected. This value is saved in UNIX TIME format.
For example: if TIMEX has 1739973831 as value, it represents the date "February 19, 2025 11:03:51 AM".

* *INTENT_HEALTH_VALUEX:* It represents the health value which can be between the next possible values:
** *0*: "Healthy"
** *1*: "Unknown"
** *2*: "At-risk"
** *3*: "Faulty"
** *4*: "Suspended"

=== Examples for retrieve intent health using GET

For example for getting the intent health using the "Condor-LS.LT1" device name, ont intent type, version 9 and target "L1.P1.W1" can be retrieved sending an HTTP GET request to the following URL:
GET https://{ip-host-example}/{wnp-pm-context}/api/query?start=1h-ago&m=sum:hi.summary.ont_9.Condor-LS.LT1{target=L1.P1.W1}

Response example:
[source, json]
----
[
    {
        "metric": "hi.summary.ont_9.Condor-LS.LT1",
        "tags": {
            "target": "L1.P1.W1"
        },
        "aggregateTags": [],
        "dps": {
            "1739892600": 3,
            "1739893500": 3,
            "1739894400": 3,
            "1739895300": 3
        }
    }
]
----

For example for getting the intent health using the "Condor-LS.LT1" device name, l2-user intent type, version 100 and target "HSI\__h_L1.P1.W1" can be retrieved sending an HTTP GET request to the following URL:
GET https://{ip-host-example}/{wnp-pm-context}/api/query?start=1h-ago&m=sum:hi.summary.l2-user_100.Condor-LS.LT1{target=HSI__h_L1.P1.W1}

Response example:
[source, json]
----
[
    {
        "metric": "hi.summary.l2-user_100.Condor-LS.LT1",
        "tags": {
            "target": "HSI__h_L1.P1.W1"
        },
        "aggregateTags": [],
        "dps": {
            "1739893500": 3,
            "1739894400": 3,
            "1739895300": 3,
            "1739896200": 3
        }
    }
]
----

=== Examples for retrieve intent health using POST

For example for getting the intent health using the "Condor-LS.LT1" device name, ont intent type, version 9 and target "L1.P1.W1" can be retrieved sending an HTTP POST request to the following URL:
POST https://{ip-host-example}/{wnp-pm-context}/api/query
including the following body:
[source, json]
----
{
    "start": "1h-ago",
    "queries": [
        {
            "metric": "hi.summary.ont_9.Condor-LS.LT1",
            "aggregator": "sum",
            "tags": {
                "target": "L1.P1.W1"
            }
        }
    ]
}
----

Response example:
[source, json]
----
[
    {
        "metric": "hi.summary.ont_9.Condor-LS.LT1",
        "tags": {
            "target": "L1.P1.W1"
        },
        "aggregateTags": [],
        "dps": {
            "1739892600": 3,
            "1739893500": 3,
            "1739894400": 3,
            "1739895300": 2
        }
    }
]
----

For example for getting the intent health using the "Condor-LS.LT1" device name, l2-user intent type, version 100 and target "L1.P1.W1" can be retrieved sending an HTTP POST request to the following URL:
POST https://{ip-host-example}/{wnp-pm-context}/api/query
including the following body:
[source, json]
----
{
    "start": "1h-ago",
    "queries": [
        {
            "metric": "hi.summary.l2-user_100.Condor-LS.LT1",
            "aggregator": "sum",
            "tags": {
                "target": "L1.P1.W1"
            }
        }
    ]
}
----

Response example:
[source, json]
----
[
    {
        "metric": "hi.summary.l2-user_100.Condor-LS.LT1",
        "tags": {
            "target": "HSI__h_L1.P1.W1"
        },
        "aggregateTags": [],
        "dps": {
            "1739893500": 4,
            "1739894400": 0,
            "1739895300": 0,
            "1739896200": 0
        }
    }
]
----

