include::ROOT:conf/Configuration_properties.adoc[leveloffset=0]

= How to consume Kafka events as {vno-initials}

== Introduction

This section describes how the {vno-initials}s are able to consume the kafka events that belongs to it.

When {app-short-name} is installed over Altiplano, the application creates topics per {vno-initials} in {app-short-name}'s Kafka service.
The topics to be created are configured in the {app-short-name} when installing the application.
Refer to xref:Installation-and-Deployment-Guide:How_to_install_and_configure_WNP_application.adoc[How to Install and Configure {app-short-name}] for more information.

{wnp-kakfa-broker} is secured not only with SSL else it is secured with SASL too.
The SASL PLAIN mechanism, which consists of identifying the client using a username and password, in the case of {wnp-kakfa-broker} is not just any password but a token obtained in a certain way.

[IMPORTANT]
The exposed ports to connect to kafka depends on the brokers configured when
installing WNP and also the IPs and hostnames added.
Refer to xref:Installation-and-Deployment-Guide:appendices/WNP_Exposed_Interfaces.adoc[{app-short-name} Exposed Interfaces]
section to know more details.

== Get SSL certificates

. On server where {app-short-name} is installed, it must kubectl and jq installed:
+
[source]
----
mkdir -p ./altiplano-wnp-certs && kubectl get secret altiplano-wnp-certs -o json | jq -r '.data | to_entries[] | "\(.key) \(.value)"' | while read -r name data; do echo "$data" | base64 -d > "./altiplano-wnp-certs/$name"; done
----
+
This command creates the *altiplano-wnp-certs* directory, it reads the secret installed in kubernetes with the {app-short-name} certificates, and it writes the next files:
+
====
- *client-crt.pem:* Client certificate (Public key).
- *client-key.pem:* Client private key.
- *server-crt.pem:* Server certificate (Public key).
- *wnp-kafka-keystore.jks:* Java Keystore, it contains the server certificates/key.
- *wnp-kafka-keystore_pass:* Keystore's Passphrase.
- *wnp-kafka-trustchain.jks:* Java Truststore, configured with the client and server certificates.
- *wnp-kafka-trustchain_pass:* Truststore's Passphrase.
- *server-key_pass:* Server's private key passphrase.
====

To connect to {wnp-kakfa-broker}, only are necessary: client-crt.pem, client-key.pem y server-crt.pem.

== Get token for SASL connection
To connect to {wnp-kakfa-broker} an access token must be retrieved.

To retrieve a token refer to the xref:How_to_manage_WNP_access.adoc[How to manage {app-short-name} access] section.

== How to connect {wnp-kakfa-broker}

For using an admin client, consumer client or producer client will not be changed with respect to the way of authenticating.
The producer/consumer configuration are different but the authentication way will the same.

To the usual SSL configuration, some SASL configuration will need to be added.

For connecting to a broker are needed: SSL configuration, SASL configuration and a topic.

=== An example using kafkacat as client

.Example for using a consumer for an {vno-initials} called *{vno-name-example}*
[source, bash, subs=attributes]
----
kafkacat -b {ip-host-example}:19093 -X security.protocol=SASL_SSL -X ssl.key.location=client-key.pem -X ssl.certificate.location=client-crt.pem -X ssl.ca.location=server-crt.pem -X sasl.mechanism=PLAIN -X sasl.username=lasermax -X sasl.password=eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ6NVRpUmItVURPOUcxaWlVZ2xyc2hGQTBWeXRhMzBaa3kzNjNwOWFSSm13In0.eyJleHAiOjE3MzM0OTI1NjYsImlhdCI6MTczMzQwNjE2NiwianRpIjoiNzEwYjU0N2QtNTM4NC00OGRlLTgzYjUtMzU0ZGZhN2U0MDk3IiwiaXNzIjoiaHR0cHM6Ly8xNzIuMjEuMS4yMzkvYWx0aXBsYW5vLXNzby9yZWFsbXMvbWFzdGVyIiwic3ViIjoiZjU5NjUyMWUtMmZiOS00YTRiLTk3ZjgtNmRmZDgwYzNmNDZiIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoid25wX2thZmthIiwic2Vzc2lvbl9zdGF0ZSI6IjUxMGNlYTNmLTkwZTQtNGIzOS05NTRiLWNhOGY3ZDZiYjczNyIsImFjciI6IjEiLCJyZXNvdXJjZV9hY2Nlc3MiOnsid25wX2thZmthIjp7InJvbGVzIjpbIldOUF9LQUZLQV9WTk8iXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJzaWQiOiI1MTBjZWEzZi05MGU0LTRiMzktOTU0Yi1jYThmN2Q2YmI3MzciLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInducF92bm9faWQiOiJURUYiLCJuYW1lIjoiVGVsZWZvbmljYSIsInByZWZlcnJlZF91c2VybmFtZSI6InRlbGVmb25pY2EiLCJnaXZlbl9uYW1lIjoiVGVsZWZvbmljYSIsImVtYWlsIjoidGVsZWZvbmljYUB0ZWxlZm9uaWNhIn0.F16ee1IKQCp_ISbxatNE91o7L0bXnWOCqO3zV9ijEr8OJW1ivUTMI5_rBxGP99Fu2_Zdg7ow4fTFIa5rGm7MGs3TUW85liUIM8TwLVDhiURib_inv6lWTVb8eBWt2D_v20xkeBsTl3gGQMwdDbCTxd9ABedjnhOXql60SutbVkz1KXA-RCAZui4QQN1x_bmpkNVx6t86rSyokccBjbATOSkFxoAuR5X5U-ToHK9lrEHGZv9X7LShuMbXsEiKECDeKH0s0MFu93utCNhBTm-DbAjpuDfP51XIB_PjIR09Xzec2wYgqSZy6G3pbM-7n2gA-J97sMQQBH51MhszSKXebA -C -t "LRM_nokia-altiplano-alarm"
----

== Subscribe to topics

The {vno-initials}s must subscribe to the kafka topics created by {app-short-name}
that follows the following format: +
<{vno-initials}-IDENTIFIER>_<ALTIPLANO-TOPIC-NAME>

- *{vno-initials}-IDENTIFIER =* It is the identifier assigned to the {vno-initials} when creating it on the application. Refer to xref:User_Guide:How_to_configure_a_VNO.adoc[How to Configure an {vno-initials}] section to know more details about the {vno-initials} identifier.

- *ALTIPLANO-TOPIC-NAME =* It is the topic name identifier on Altiplano's Kafka.

== Subscribing examples

=== ALARMS Topic
Suppose an {vno-initials} called *{vno-name-example}* identified by *{vno-identifier-example}* wants to subscribe to
the {app-short-name} *"nokia-altiplano-alarm"* topic in order to receive the alarm notifications.
Instead of subscribing to that topic it must subscribe to *"LRM_nokia-altiplano-alarm"* topic.

=== INTENT_HEALTH Topic
Suppose an {vno-initials} called *{vno-name-example}* identified by *{vno-identifier-example}* wants to subscribe to
the {app-short-name} *"INTENT_HEALTH"* topic in order to receive intent health change notifications.
Instead of subscribing to that topic it must subscribe to *"LRM_INTENT_HEALTH"* topic.

=== LIGHTSPAN Topics

==== IPFIX-XPON Topic
Suppose an {vno-initials} called *{vno-name-example}* identified by *{vno-identifier-example}* wants to subscribe to
the {app-short-name} *"IPFIX-XPON"* topic in order to receive IPFIX notifications.
Instead of subscribing to that topic it must subscribe to *"LRM_IPFIX-XPON"* topic.

==== NCLIVE-XPON Topic
Suppose an {vno-initials} called *{vno-name-example}* identified by *{vno-identifier-example}* wants to subscribe to
the {app-short-name} *"NCLIVE-XPON"* topic in order to receive NCLIVE notifications.
Instead of subscribing to that topic it must subscribe to *"LRM_NCLIVE-XPON"* topic.

ifdef::isamSupport[]
=== ISAM Topics

==== SDCbulk-ISAM Topic
Suppose an {vno-initials} called *{vno-name-example}* identified by *{vno-identifier-example}* wants to subscribe to
the {app-short-name} *"SDCbulk-ISAM"* topic in order to receive SDCbulk notifications.
Instead of subscribing to that topic it must subscribe to *"LRM_SDCbulk-ISAM"* topic.

==== SNMPLive-ISAM Topic
Suppose an {vno-initials} called *{vno-name-example}* identified by *{vno-identifier-example}* wants to subscribe to
the {app-short-name} *"SNMPLive-ISAM"* topic in order to receive SNMPLive notifications.
Instead of subscribing to that topic it must subscribe to *"LRM_SNMPLive-ISAM"* topic.
endif::isamSupport[]

include::ROOT:go-back-component.adoc[Back]