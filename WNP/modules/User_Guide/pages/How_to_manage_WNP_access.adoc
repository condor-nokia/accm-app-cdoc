include::ROOT:conf/Configuration_properties.adoc[leveloffset=0]

= How to Manage {app-short-name} access

== Introduction

This section provides the steps required to create users and authenticate to the {app-short-name}.

To execute any operation on {app-short-name} you must be previously authenticated using
{inp-initials} or {vno-initials} user credentials.

== Authentication Methods
{app-short-name} use Altiplano's keycloak to authenticate users and clients.
It offers flexible and robust mechanisms for applications to authenticate users/clients and manage access.
The choice of the appropriate authentication flow typically depends on the nature of the client application and the desired level of isolation.

Below is a list of the authentication methods available, categorized by the {app-short-name} interfaces.

=== Web UI
To authenticate to the web UI a new user must be created in the master realm because the UI uses
the wnp_portal client created on keycloak.
To know more details about how to create users to access the web UI please refer
to the xref:_create_new_users_for_the_webui[Create new users for the Web UI] section.
To know more details about how to authenticate using the created users please
refer to the xref:_authenticating_to_web_ui[Authenticating to the Web UI] section.


=== REST APIs, proxies and kafka brokers
To authenticate to the {app-short-name} REST APIs, proxies and kafka brokers
there are three different authentication methods:

. Dedicated client in master realm without system users: This method consists of
using a dedicated client per {vno-initials} and a dedicated client for inp in the "master" realm of the keycloak.
The dedicated client for INP privileges is created when installing WNP and loading
the clients configurations. The dedicated client per {vno-initials} must be created
each time a new {vno-initials} is added.
To know more details about how to create dedicated clients please refer
to the xref:_create_dedicated_clients_for_the_rest_apis_proxies_and_kafka_brokers[Create dedicated client to access REST API, proxies and kafka brokers] section.
To know more details about how to authenticate using a dedicated client please
refer to the xref:_authenticating_to_the_rest_apis_and_proxies_using_dedicated_client[Authenticating to the REST APIs, proxies and kafka brokers using dedicated client] section.

. Shared client in system realm with system users: This method allows
to model system accounts in the keycloak "system" realm that allows users to
authenticate using username and password.
To know more details about how to create system users please refer
to the xref:_create_system_users_to_access_rest_apis_proxies_and_kafka_brokers_using_the_shared_client[Create system users to access REST API, proxies and kafka brokers] section.
To know more details about how to authenticate using a system user please
refer to the xref:_authenticating_to_the_rest_apis_and_proxies_using_system_users_and_shared_client[Authenticating to the REST APIs, proxies and kafka brokers using system users] section.

. Enabling Direct Access Grants on wnp_portal client (Not recommended): this method can be used to
simplify the process for users to obtain an access token.
By enabling this feature, users are able to obtain a token more easily by providing just their username and password.
This method eliminates the need for additional clients creation, allowing for a quicker and more straightforward authentication process.
This method is considered unsecure but easier to configure than the others.
It must be used only if the environment where the application is installed is controlled
and secure.
To know more details about how to enable direct access grants please refer
to the xref:_enabling_direct_access_grants_to_wnp_portal_client_unsecure[Enabling direct access grants to wnp_portal client] section.
To know more details about how to authenticate using a Web UI username and password               } \0-ñ{´+} please
refer to the xref:_authenticating_to_the_rest_apis_proxies_and_kafka_brokers_using_webui_usernames_and_passwords_not_recommended[Authenticating to the REST APIs, proxies and kafka brokers using WebUI usernames and passwords] section.


== How to Create {app-short-name} users and clients

=== Create new users for the WebUI
This section explains how to create new users to be used in {app-short-name}.

{app-full-name} allows users of two different profiles:

- *{inp-initials} user:* Allows an {inp-initials} to configure the {app-short-name}.
- *{vno-initials} user:* Allows an {vno-initials} to use the {app-short-name}.

==== Create an {inp-initials} user
In order to provide a new {inp-initials} User, follow the next steps:

. Create a new Altiplano admin within the {main-base-app} master realm.
. Navigate to 'Users'.
. Select the created user.
. Go to the "Groups" section.
. Add the "wnp_inp" group to the user.

==== Create an {vno-initials} user
In order to provide a new {vno-initials} User, follow the next steps:

. Create a new user within the {main-base-app} master realm.
. Navigate to 'Users'.
. Select the created user.
. Go to the "Attributes" section.
. Add a new attribute with key "wnp_vno_id" and value that matches the identifier assigned to the {vno-initials}.
. Go to the "Groups" section.
. Add the "wnp_kafka_vno" group to the user.

For example:: If you have created an {vno-initials} called *{vno-name-example}* with identifier *{vno-identifier-example}* then the user for that {vno-initials}
must contains the attribute *wnp_vno_id* with value *{vno-identifier-example}*  in keycloak.

=== Create dedicated clients for the REST APIs, proxies and kafka brokers
==== Create an {inp-initials} dedicated client
The {inp-initials} dedicated client is created by default when {app-short-name} keycloak is configured
as part of the installation steps.
This client can be found under the name "wnp_inp_service" in the "master" realm.

==== Create an {vno-initials} dedicated client
In order to provide a new {vno-initials} keycloak client that allows the use of the {app-short-name}
REST APIs, proxies and kafka brokers, follow the next steps:

. Access to Altiplano's keycloak
. Navigate to the Clients section within the {main-base-app} master realm.
. Click on "Import client" link.
. Upload the file called "wnp_vno-keycloak_template.json"
. Fill in the Client ID, for example, "wnp_isp_lrm_service". Optionally you can also add a name and a description.
. Click Save. You'll be redirected to the newly created client's page.
. Go to the Clients Scope tab.
. Search in the list the scope named dedicated and click it. This will display the mappers.
. Open the mapper titled Vno Identifier Claim.
. In the form, change the Claim value from $\{VNO_IDENTIFIER} to the VNO identifier. For example: {vno-identifier-example}. Remember that this identifier must match with the one assigned in the creation of the VNO on WNP.
. Click the save button.
. Go back to the created client details
. Go to "Service account roles" and click on the service account username. For example, in this case it is found under the name "service-account-wnp_isp_lrm_service"
. Go to the "Groups" section.
. Add the "wnp_kafka_vno" group.

=== Create system users to access REST APIs, proxies and kafka brokers using the shared client
==== Create new {vno-initials} system user
. Create a new user within the {main-base-app} "system" realm.
. Navigate to 'Users'.
. Select the created user.
. Go to the "Attributes" section.
. Add a new attribute with key "wnp_vno_id" and value that matches the identifier assigned to the {vno-initials}.
. Go to the "Groups" section.
. Add the "wnp_kafka_vno" group to the user

==== Create new {inp-initials} system user
. Create a new user within the {main-base-app} "system" realm.
. Navigate to 'Users'.
. Select the created user.
. Go to the "Groups" section.
. Add the "wnp_inp" group to the user.

=== Enabling Direct access grants to wnp_portal client (unsecure)
Direct Access Grants can be enabled to simplify the process for users to obtain an access token.
By enabling this feature, users are able to obtain a token more easily by providing just their username and password.
This method eliminates the need for additional steps, such as authorization codes or complex workflows, allowing for a quicker and more straightforward authentication process.

By default, direct access grants capabilities are not enabled on "wnp_portal" client in Altiplano’s Keycloak.
To enable it go to wnp_portal client details on the "master" realm and activate
the "Direct Access Grants" option. Also, the "Client Authentication" option can be disabled
to avoid the needs of sending wnp_portal client secret to retrieve a token.

== How to Authenticate

=== Authenticating to Web UI
To authenticate to the UI the user must previously exist in keycloak.
If you do not have one please see the xref:_create_new_users_for_the_webui[Create new users] section.

To use the {app-short-name} through the WebUI you must:

. Access the {app-short-name} WebUI using the following URL: +
link:https://{altiplano-host}/{wnp-web-context}[https://{altiplano-host}/{wnp-web-context},window=_blank]
+
For example:: https://{ip-host-example}/{wnp-web-context}/

. Log in to {app-short-name} using a specific username and password.
+
image::wnpLogin.png[align="center"]

=== Authenticating to the REST APIs and proxies using dedicated client
To authenticate in order to use WNP REST APIs, proxies and kafka brokers an access token is needed.

[NOTE]
====
The generated access token must be used in the HTTP header as a Bearer authentication header when executing
any of {app-short-name} operations through the {app-short-name} REST APIs or proxies
and in the "sasl.password" parameter when connecting to kafka brokers.
====

==== Authenticating as {inp-initials}
If you need to authenticate as {inp-initials} user, you must retrieve a token using the client id wnp_inp_service
and the corresponding secret.

The token can be retrieved using the following information:

- Grant Type: client_credentials
- Access token url: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token
- WNP keycloak client id: wnp_inp_service
- WNP keycloak client secret: The secret for the client. This can be found under the "credentials" section of the client details in keycloak.

===== Get Token using CURL

.Usage
[source, bash, subs=attributes]
----
curl --location 'https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=wnp_inp_service' \
--data-urlencode 'client_secret=CLIENT_SECRET'
----

.Example
[source, bash, subs=attributes]
----
curl --location 'https://{ip-host-example}/altiplano-sso/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=wnp_inp_service' \
--data-urlencode 'client_secret=Xo725aK1P7gZgtJd07YgXq4UCubTGkXk'
----
===== Get Token using Postman

The steps to retrieve a token from Postman are as follows:

. Create new request
. Go to *Authorization* tab:

image::authenticateSection_obtainTokenINP1.png[align="center"]

. Enter the next required data:
+
--
- Select the Grand type = "Client credentials".
- Access Token URL: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token
- Client ID: wnp_inp_service
- WNP keycloak client secret: The secret of the client. This can be found under the "credentials" section of the client details in keycloak.
--

. Click the *Get New Access Token* button
+
image::authenticateSection_obtainToken2.png[align="center"]

. The generated token was generated. Click the *Use Token*:
+
image::authenticateSection_obtainToken3.png[align="center"]

. The generated token can be copied from *Token* field.
+
image::authenticateSection_obtainToken4.png[align="center"]


==== Authenticating as an {vno-initials}
To authenticate as an {vno-initials} to use WNP REST APIs, proxies and kafka brokers a dedicated client must exist on the "master" realm of Keycloak.
If you do not have the client for the {vno-initials} please see the xref:_create_an_isp_dedicated_client[Create new {vno-initials} dedicated client] section.

The token can be retrieved using the following information:

- Grant Type: client_credentials
- Access token url: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token
- WNP keycloak client id: the id of the client created in keycloak for the {vno-initials}.
- WNP keycloak client secret: The secret for the client. This can be found under the "credentials" section of the client details in keycloak.

===== Get Token using CURL

.Usage
[source, bash, subs=attributes]
----
curl --location 'https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id={vno-initials}_CLIENT_ID' \
--data-urlencode 'client_secret={vno-initials}_CLIENT_SECRET'
----

.Example
[source, bash, subs=attributes]
----
curl --location 'https://{ip-host-example}/altiplano-sso/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=wnp_isp_lrm_service' \
--data-urlencode 'client_secret=Xo725aK1P7gZgtJd07YgXq4UCubTGkXk'
----

===== Get Token using Postman

The steps to retrieve a token from Postman are as follows:

. Create new request
. Go to *Authorization* tab:
+
image::authenticateSection_obtainTokenISP1.png[align="center"]

. Enter the next required data:
+
--
- Select the Grand type = "Client credentials".
- Access Token URL: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token
- Client ID: The id of the client in keycloak for the {vno-initials}.
- WNP keycloak client secret: The secret of the client. This can be found under the "credentials" section of the client details in keycloak.
--

. Click the *Get New Access Token* button
+
image::authenticateSection_obtainToken2.png[align="center"]

. The generated token was generated. Click the *Use Token*:
+
image::authenticateSection_obtainToken3.png[align="center"]

. The generated token can be copied from *Token* field.
+
image::authenticateSection_obtainToken4.png[align="center"]


=== Authenticating to the REST APIs and proxies using system users and shared client
To authenticate in order to use WNP REST APIs, proxies and kafka brokers an access token is needed.

[NOTE]
====
The generated access token must be used in the HTTP header as a Bearer authentication header when executing
any of {app-short-name} operations through the {app-short-name} REST APIs or proxies
and in the "sasl.password" parameter when connecting to kafka brokers.
====

==== Authenticating as {inp-initials} or {vno-initials}
If you need to authenticate as {inp-initials} or {vno-initials} user, you must retrieve a token using the client id wnp_services
that was loaded to system realm on the keycloak when installing {app-short-name}.

The token can be retrieved using the following information:

- Grant Type: password
- Access token url: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/system/protocol/openid-connect/token
- WNP keycloak client id: wnp_services
- Username: The username of the user to authenticate
- Password: The password of the user to authenticate


===== Get Token using CURL

.Usage
[source, bash, subs=attributes]
----
curl --location 'https://{altiplano-host}/altiplano-sso/realms/system/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'client_id=wnp_services' \
--data-urlencode 'username=INP OR ISP USERNAME' \
--data-urlencode 'password=INP OR ISP PASSWORD'
----

.Example
[source, bash, subs=attributes]
----
curl --location 'https://{ip-host-example}/altiplano-sso/realms/system/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'client_id=wnp_services' \
--data-urlencode 'username=lasermax_admin_system' \
--data-urlencode 'password=lasermax_admin_system_password'
----
===== Get Token using Postman

The steps to retrieve a token from Postman are as follows:

. Create new request
. Go to *Authorization* tab:
+
image::authenticateSection_obtainTokenSharedClientISP.png[align="center"]

. Enter the next required data:
+
--
- Select the Grand type = "Password credentials".
- Access Token URL: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/system/protocol/openid-connect/token
- Client ID: wnp_services.
- Username: The username of the ISP or INP to authenticate
- Password: The password of the user to authenticate
--

. Click the *Get New Access Token* button
+
image::authenticateSection_obtainToken2.png[align="center"]

. The generated token was generated. Click the *Use Token*:
+
image::authenticateSection_obtainToken3.png[align="center"]

. The generated token can be copied from *Token* field.
+
image::authenticateSection_obtainToken4.png[align="center"]

=== Authenticating to the REST APIs, proxies and kafka brokers using WebUI usernames and passwords (not recommended)
To authenticate in order to use WNP REST APIs, proxies and kafka brokers an access token is needed.

[NOTE]
====
The generated access token must be used in the HTTP header as a Bearer authentication header when executing
any of {app-short-name} operations through the {app-short-name} REST APIs or proxies
and in the "sasl.password" parameter when connecting to kafka brokers.
====

To use this method the direct access grants must be previously enabled on the wnp_portal
client of the master realm. After enabling Direct access grants the existent WebUI users
can retrieve tokens sending an authentication request of password credential type.

The token can be retrieved using the following information:

- Grant Type: password
- Access token url: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token
- WNP keycloak client id: wnp_portal
- wnp_portal client secret (only needed if "Client authentication" option is enabled): WNP_PORTAL_SECRET
- Username: The username of the user to authenticate
- Password: The password of the user to authenticate


===== Get Token using CURL

.Usage
[source, bash, subs=attributes]
----
curl --location 'https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'client_id=wnp_portal' \
--data-urlencode 'username=INP OR ISP USERNAME' \
--data-urlencode 'password=INP OR ISP PASSWORD'
----

.Example
[source, bash, subs=attributes]
----
curl --location 'https://{ip-host-example}/altiplano-sso/realms/master/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'client_id=wnp_portal' \
--data-urlencode 'username=lasermax_admin' \
--data-urlencode 'password=lasermax_admin_password'
----
===== Get Token using Postman

The steps to retrieve a token from Postman are as follows:

. Create new request
. Go to *Authorization* tab:
+
image::authenticateSection_obtainTokenDAGISP.png[align="center"]

. Enter the next required data:
+
--
- Select the Grand type = "Password credentials".
- Access Token URL: The Altiplano keycloak token url. For example: https://{altiplano-host}/altiplano-sso/realms/master/protocol/openid-connect/token
- Client ID: wnp_portal.
- Username: The username of the ISP or INP to authenticate
- Password: The password of the user to authenticate
--

. Click the *Get New Access Token* button
+
image::authenticateSection_obtainToken2.png[align="center"]

. The generated token was generated. Click the *Use Token*:
+
image::authenticateSection_obtainToken3.png[align="center"]

. The generated token can be copied from *Token* field.
+
image::authenticateSection_obtainToken4.png[align="center"]


include::ROOT:go-back-component.adoc[Back]